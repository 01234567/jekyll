#!/usr/bin/env ruby
STDOUT.sync = true

$:.unshift File.join(File.dirname(__FILE__), *%w{ .. lib })

require 'jekyll'

Jekyll::Commando.program(:jekyll) do |p|
  p.version Jekyll::VERSION
  p.description 'Jekyll is a blog-aware, static site generator in Ruby'

  p.option 'source', '-s', '--source DIR', 'Source directory (defaults to ./)'
  p.option 'destination', '-d', '--destination DIR', 'Destination directory (defaults to ./_site)'
  p.option 'safe', '--safe', 'Safe mode (defaults to false)'
  p.option 'plugins', '--plugins', 'Plugins directory (defaults to ./_plugins)'
  p.option 'layouts', '--layouts', 'Layouts directory (defaults to ./_layouts)'

  p.command(:new) do |c|
    c.syntax 'jekyll new PATH'
    c.description 'Creates a new Jekyll site scaffold in PATH'

    c.action do |args, options|
      Jekyll::Commands::New.process(args)
    end
  end

  p.command(:build) do |c|
    c.syntax 'jekyll build [options]'
    c.description 'Build your site'

    c.option 'future', '--future', 'Publishes posts with a future date'
    c.option 'limit_posts', '--limit-posts MAX_POSTS', Integer, 'Limits the number of posts to parse and publish'
    c.option 'watch', '-w', '--watch', 'Watch for changes and rebuild'
    c.option 'lsi', '--lsi', 'Use LSI for improved related posts'
    c.option 'show_drafts', '--drafts', 'Render posts in the _drafts folder'

    c.action do |args, options|
      options['serving'] = false
      config = Jekyll.configuration(options)
      Jekyll::Commands::Build.process(config)
    end
  end

  p.command(:serve) do |c|
    c.syntax 'jekyll serve [options]'
    c.description 'Serve your site locally'
    c.alias(:server)

    c.option 'future', '--future', 'Publishes posts with a future date'
    c.option 'limit_posts', '--limit_posts MAX_POSTS', 'Limits the number of posts to parse and publish'
    c.option 'watch', '-w', '--watch', 'Watch for changes and rebuild'
    c.option 'lsi', '--lsi', 'Use LSI for improved related posts'
    c.option 'show_drafts', '--drafts', 'Render posts in the _drafts folder'

    c.option 'port', '-p', '--port PORT', 'Port to listen on'
    c.option 'host', '-h', '--host HOST', 'Host to bind to'
    c.option 'baseurl', '-b', '--baseurl URL', 'Base URL'

    c.action do |args, options|
      options['serving'] = true
      config = Jekyll.configuration(options)
      Jekyll::Commands::Build.process(config)
      Jekyll::Commands::Serve.process(config)
    end
  end

  p.command(:import) do |c|
    c.syntax 'jekyll import <platform> [options]'
    c.description 'Import your old blog to Jekyll'

    c.action do |args, options|
      begin
        require 'jekyll-import'
      rescue LoadError
        msg  = "You must install the 'jekyll-import' gem before continuing.\n"
        msg += "* Do this by running `gem install jekyll-import`.\n"
        msg += "* Or if you need root privileges, run `sudo gem install jekyll-import`."
        abort msg
      end
      Jekyll::Commands::Import.process(args.first, options)
    end
  end
end
